{% extends "base.html" %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('pdf.static', filename='pdf_grader/css/report_overview.css') }}">
{% endblock %}

{% block navigation %}
<nav class="fixed-top navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="{{ url_for(request.blueprint + '.index') }}">課題一覧</a></li>
            </ul>
        </div>
    </div>
</nav>
{% endblock %}


{% macro render_cell(score, status, late, report_id, student_id, col_name, report_list) %}
    {% if col_name in report_list %}

    <td class="report-cell score-cell 
            {% if status == '◎' %}bg-perfect
            {% elif status == '詳' %}bg-detail
            {% elif status == '答' %}bg-answer
            {% elif status == '同' %}bg-same
            {% elif status == '×' %}bg-none
            {% endif %} 
            style="text-align: left; vertical-align: middle;">
            {# 中央にスコアを表示 #}
            {% if student_id >= 0 %}
                <span class="main-score"><a href="{{ url_for('pdf.viewer', student_index=student_id, report_index=report_id) }}">{{ score }}</a></span>
            {% else %}
                <span class="main-score">{{ score }}</span>
            {% endif %}
            {% if late == '遅' %}
                <span class="late-indicator">遅</span>
            {% elif late == '大遅' %}
                <span class="very-late-indicator">大遅</span>
            {% endif %}
            {% if status == "◎" %}
                <span class="perfect-indicator">◎</span>
                {% elif status == "詳" %}
                <span class="detail-indicator">詳</span>
                {% elif status == "答" %}
                <span class="answer-indicator">答</span>
                {% elif status == "同" %}
                <span class="same-indicator">同</span>
                {% elif status == "×" %}
                 <span class="none-indicator">×</span>
            {% endif %}
            <span>  </span>
    </td>

    {% elif col_name == '平均点' %}
            {# 平均点列：JSで色を塗るために average-score-cell クラスを付与 #}
            <td class="average-score-cell" style="text-align: right;">{{ score }}</td>

    {% elif col_name == '評価' %}
        {# 評価列：初期状態のクラスを grade-cell に #}
        <td class="grade-cell" style="text-align: center; font-weight: bold;">{{ score }}</td>
    {% elif col_name == '欠席回数' %}
        {% if score|int >= 6 %}
            <td class="bg-absence">{{ score }}</td>
        {% else %}
            <td>{{ score }}</td>
        {% endif %}
    {% else %}
        <td>{{ score }}</td>
    {% endif %}
{% endmacro %}

{% block content %}
<h1>{{ 'レポート提出状況' if mode == 'status' else 'レポート得点一覧' }}</h1>

{% if mode == 'scores' %}
<div style="margin-bottom: 20px;">
    {# XLSXダウンロードボタン #}
    <a href="{{ url_for('pdf.download_report_xlsx') }}" class="btn btn-success">
        Excel (.xlsx) で保存
    </a>
</div>
{% endif %}
<table class="status-table">
    <tr class="bg-header">
        {% for col in columns %} <th>{{ col }}</th> {% endfor %}
    </tr>
{% for i in range(enrolled|length) %}
<tr>
{% set ns_un = namespace(report_idx=0) %}
    {% for col in columns %}
        {# 各リストから同じ位置のデータを取り出す #}
        {% set score_val = enrolled[i][col] %}
        {% set status_val = enrolled_status[i][col] if col in report_list else '' %}
        {% set late_val = enrolled_late[i][col] if col in report_list else '' %}
        {% set id_val = enrolled_id[i][col] if col in report_list else '' %}
        
        {{ render_cell(score_val, status_val, late_val, ns_un.report_idx, id_val, col, report_list) }}
        {% if col in report_list %}
            {% set ns_un.report_idx = ns_un.report_idx + 1 %}
        {% endif %}
    {% endfor %}
</tr>
{% endfor %}
</table>



{# 名簿外も同様にマクロを使用 #}
{% if unlisted %}
<h2 style="color: red; margin-top: 40px;">⚠️ 名簿外の学生</h2>
<table class="status-table">
    <tr class="bg-header">
        {% for col in columns %} <th>{{ col }}</th> {% endfor %}
    </tr>
{% for i in range(unlisted|length) %}
<tr>
{% set ns_un = namespace(report_idx=0) %}
    {% for col in columns %}
        {# 各リストから同じ位置のデータを取り出す #}
        {% set score_val = unlisted[i][col] %}
        {% set status_val = unlisted_status[i][col] if col in report_list else '' %}
        {% set late_val = unlisted_late[i][col] if col in report_list else '' %}
        {% set id_val = unlisted_id[i][col] if col in report_list else '' %}
        
        {{ render_cell(score_val, status_val, late_val, ns_un.report_idx, id_val, col, report_list) }}
        {% if col in report_list %}
            {% set ns_un.report_idx = ns_un.report_idx + 1 %}
        {% endif %}
    {% endfor %}
</tr>
{% endfor %}
</table>
{% endif %}

{% if mode == 'scores' %}
<div class="card p-3 mb-4 shadow-sm">
    <h5 class="card-title mb-3">スコア色分け・計算設定</h5>
    
    <div class="row g-3 mb-4">
        <div class="col-md-2">
            <label class="form-label text-primary">S (以上)</label>
            <input type="number" id="threshold-s" class="form-control score-input" value="{{ config['THRESHOLD_S'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label text-primary">A (以上)</label>
            <input type="number" id="threshold-a" class="form-control score-input" value="{{ config['THRESHOLD_A'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label text-primary">B (以上)</label>
            <input type="number" id="threshold-b" class="form-control score-input" value="{{ config['THRESHOLD_B'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label text-primary">C (以上)</label>
            <input type="number" id="threshold-c" class="form-control score-input" value="{{ config['THRESHOLD_C'] }}">
        </div>
        <div class="col-md-4">
            <label class="form-label text-danger">大遅延の境界 (日)</label>
            <input type="number" id="delay-threshold-days" class="form-control score-input" value="{{ config['DELAY_THRESHOLD_DAYS'] }}">
        </div>
    </div>

    <hr>

    <div class="row g-3">
        <div class="col-md-2">
            <label class="form-label">詳細のみ比率</label>
            <input type="number" step="0.1" id="ratio-detail-only" class="form-control score-input" value="{{ config['RATIO_DETAIL_ONLY'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">解答のみ比率</label>
            <input type="number" step="0.1" id="ratio-answer-only" class="form-control score-input" value="{{ config['RATIO_ANSWER_ONLY'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">詳細と解答に同ファイル比率</label>
            <input type="number" step="0.1" id="ratio-duplicate" class="form-control score-input" value="{{ config['RATIO_DUPLICATE'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">遅延比率</label>
            <input type="number" step="0.1" id="ratio-late" class="form-control score-input" value="{{ config['RATIO_LATE'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">大遅延比率</label>
            <input type="number" step="0.1" id="ratio-very-late" class="form-control score-input" value="{{ config['RATIO_VERY_LATE'] }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button onclick="saveThresholds()" class="btn btn-primary w-100">設定を保存</button>
        </div>
    </div>
</div>
{% endif %}





{% if mode=='scores' and stats %}
<div class="card p-3 mb-4 shadow-sm border-primary">
    <h5 class="card-title">成績分布サマリー</h5>
    <div class="row text-center">
        {% for grade, data in stats.items() %}
        <div class="col">
            <div class="border rounded p-2">
                <strong class="h4 grade-text-{{ grade }}">{{ grade }}</strong><br>
                <span class="h5" id="stat-count-{{ grade }}">{{ data.count }}</span>名<br>
                <small class="text-muted" id="stat-ratio-{{ grade }}">{{ data.ratio }}%</small>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}


{% endblock %}

{% block scripts %}
{% if mode == 'scores' %}
<script src="{{ url_for('pdf.static', filename='pdf_grader/js/report_overview.js') }}"></script>
{% endif %}
{% endblock %}
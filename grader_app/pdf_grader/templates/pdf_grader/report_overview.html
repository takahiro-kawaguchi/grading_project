{% extends "base.html" %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('pdf.static', filename='pdf_grader/css/report_overview.css') }}">
{% endblock %}

{% block navigation %}
<nav class="fixed-top navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="{{ url_for(request.blueprint + '.index') }}">課題一覧</a></li>
            </ul>
        </div>
    </div>
</nav>
{% endblock %}


{% macro render_cell(val, col_name, report_list, mode) %}
    {% if col_name in report_list %}
        {# 各課題の点数列 #}
        {% if mode == 'status' %}
            <td class="{% if '◎' in val %}bg-perfect{% elif '詳' in val %}bg-detail{% elif '答' in val %}bg-answer{% elif '×' in val %}bg-none{% endif %} {% if '遅' in val %}bg-late{% endif %}">
                {{ val }}
            </td>
        {% else %}
            {# スコアモード：JSで色を塗るために score-cell クラスを付与 #}
            <td class="score-cell" style="text-align: right;">{{ val }}</td>
        {% endif %}

    {% elif col_name == '平均点' %}
            {# 平均点列：JSで色を塗るために average-score-cell クラスを付与 #}
            <td class="average-score-cell" style="text-align: right;">{{ val }}</td>

    {% elif col_name == '評価' %}
        {# 評価列：初期状態のクラスを grade-cell に #}
        <td class="grade-cell" style="text-align: center; font-weight: bold;">{{ val }}</td>
    {% else %}
        <td>{{ val }}</td>
    {% endif %}
{% endmacro %}

{% block content %}
<h1>{{ 'レポート提出状況' if mode == 'status' else 'レポート得点一覧' }}</h1>

{% if mode == 'scores' %}
<div style="margin-bottom: 20px;">
    {# XLSXダウンロードボタン #}
    <a href="{{ url_for('pdf.download_report_xlsx') }}" class="btn btn-success">
        Excel (.xlsx) で保存
    </a>
</div>
{% endif %}
<table class="status-table">
    <tr class="bg-header">
        {% for col in columns %} <th>{{ col }}</th> {% endfor %}
    </tr>
    {% for row in enrolled %}
    <tr>
        {% for col in columns %}
            {{ render_cell(row[col], col, report_list, mode) }}
        {% endfor %}
    </tr>
    {% endfor %}
</table>

{# 名簿外も同様にマクロを使用 #}
{% if unlisted %}
<h2 style="color: red; margin-top: 40px;">⚠️ 名簿外の学生</h2>
<table class="status-table">
    <tr class="bg-header">
        {% for col in columns %} <th>{{ col }}</th> {% endfor %}
    </tr>
    {% for row in unlisted %}
    <tr>
        {% for col in columns %}
            {{ render_cell(row[col], col, report_list, mode) }}
        {% endfor %}
    </tr>
    {% endfor %}
</table>
{% endif %}

{% if mode == 'scores' %}
<div class="card p-3 mb-4 shadow-sm">
    <h5 class="card-title">スコア色分け・評価設定</h5>
    <div class="row g-3">
        <div class="col-md-2">
            <label class="form-label">S (以上)</label>
            <input type="number" id="threshold-s" class="form-control score-input" value="{{ config['THRESHOLD_S'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">A (以上)</label>
            <input type="number" id="threshold-a" class="form-control score-input" value="{{ config['THRESHOLD_A'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">B (以上)</label>
            <input type="number" id="threshold-b" class="form-control score-input" value="{{ config['THRESHOLD_B'] }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">C (以上)</label>
            <input type="number" id="threshold-c" class="form-control score-input" value="{{ config['THRESHOLD_C'] }}">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button onclick="saveThresholds()" class="btn btn-primary w-100">設定を保存</button>
        </div>
    </div>
</div>
{% endif %}

{% if mode == 'scores' and stats %}
<div class="card p-3 mb-4 shadow-sm border-primary">
    <h5 class="card-title">成績分布サマリー</h5>
    <div class="row text-center">
        {% for grade, data in stats.items() %}
        <div class="col">
            <div class="border rounded p-2">
                <strong class="h4 grade-text-{{ grade }}">{{ grade }}</strong><br>
                <span class="h5" id="stat-count-{{ grade }}">{{ data.count }}</span>名<br>
                <small class="text-muted" id="stat-ratio-{{ grade }}">{{ data.ratio }}%</small>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}


{% endblock %}

{% block scripts %}
{% if mode == 'scores' %}
<script src="{{ url_for('pdf.static', filename='pdf_grader/js/report_overview.js') }}"></script>
{% endif %}
{% endblock %}